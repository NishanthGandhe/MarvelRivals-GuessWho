<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marvel Rivals - Guess Who?</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        /* --- FONT & IMAGE ASSETS --- */
        @font-face {
            font-family: 'MarvelFont';
            src: url('./MarvelFont.otf') format('opentype');
        }

        body {
            font-family: 'MarvelFont', sans-serif;
            background-image: url('./default.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: #e2e8f0;
            font-weight: 400;
            margin: 0;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: -1;
        }

        .main-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem;
        }
        
        .comic-title {
            font-family: 'MarvelFont', sans-serif;
            color: #fef2f2;
            -webkit-text-stroke: 2px #ef4444;
            text-shadow: 4px 4px 0 #000, 0 0 20px #ef4444;
        }

        .start-screen-box {
            background-color: rgba(0, 0, 0, 0.7);
            border: 3.5px solid #dce1f4e8;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }
        
        .mode-link-box {
            display: flex;
            position: relative;
            height: 80px;
            width: 205px;
            background-color: rgba(0, 0, 0, 0.6);
            border: none;
            justify-content: center;
            align-items: center;
            color: #fff;
            font-size: 18px;
            font-family: 'MarvelFont', sans-serif;
            transition: transform 0.2s ease-in-out, background-color 0.2s ease-in-out;
            z-index: 1;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.9);
            text-decoration: none;
        }

        .mode-link-box::before {
            content: '';
            position: absolute;
            top: -22px;
            left: -34px;
            width: 260px;
            height: 125px;
            background-image: url('./skinnyborder.png');
            background-size: contain;
            background-repeat: no-repeat;
            pointer-events: none;
            transition: background-image 0.2s ease-in-out;
        }

        .mode-link-box:hover {
            transform: scale(1.02);
            background-color: rgba(0, 0, 0, 0.3);
        }

        .mode-link-box:hover::before {
            background-image: url('./border.png');
        }

        .player-board {
            background-color: rgba(0, 0, 0, 0.7);
            border: 3.5px solid #dce1f4e8;
        }

        .player-board.active {
            border-color: #facc15;
        }
        .player-board.active-p2 {
             border-color: #f87171;
        }
        
        .character-card {
            transition: transform 0.3s, filter 0.3s, opacity 0.3s, border-color 0.3s;
            cursor: pointer;
            border: 2px solid #dce1f4e8; /* White-ish border */
            background-color: rgba(0, 0, 0, 0.6);
            min-height: 120px; /* Ensure consistent card height */
        }
        .character-card:hover {
            transform: scale(1.05);
            border-color: #facc15; /* Yellow border on hover */
        }
        .character-card.flipped {
            transform: scale(0.9);
            filter: grayscale(100%);
            opacity: 0.4;
        }
        .mystery-card { 
            border: 2px dashed #4b5563;
            background-color: rgba(0, 0, 0, 0.7);
            border: 3.5px solid #dce1f4e8;
        }

        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.8); display: flex;
            justify-content: center; align-items: center; z-index: 100;
        }
        .modal-content {
            background-color: rgba(0, 0, 0, 0.9);
            padding: 2rem; border-radius: 0.75rem;
            text-align: center; border: 3.5px solid #dce1f4e8;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        
        #game-container.hidden, #start-screen.hidden, .modal-backdrop.hidden, .view-container.hidden { display: none; }
    </style>
</head>
<body>
    <div class="overlay"></div>

    <div class="main-content">
        <div class="max-w-7xl mx-auto flex flex-col items-center justify-center min-h-full">
            <div class="text-center mb-8">
                <h1 class="text-6xl md:text-7xl font-bangers tracking-wider comic-title">Marvel Rivals: Guess Who?</h1>
                <p id="instructions" class="text-gray-300 mt-2 text-lg font-marvel">Create or join a game to start playing!</p>
            </div>

            <!-- Start Screen -->
            <div id="start-screen" class="p-6 rounded-xl shadow-2xl text-center max-w-lg mx-auto start-screen-box flex flex-col items-center space-y-4">
                <a href="#" id="createGameBtn" class="mode-link-box">Create New Game</a>
                <div class="text-gray-400 font-marvel">OR</div>
                <div class="flex flex-col items-center space-y-4">
                    <input type="text" id="gameIdInput" placeholder="Enter Game ID to Join" class="w-full max-w-xs bg-gray-700 text-white border border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-yellow-500 font-marvel text-center">
                    <a href="#" id="joinGameBtn" class="mode-link-box">Join Game</a>
                </div>
            </div>

            <!-- Game Container -->
            <div id="game-container" class="hidden w-full">
                <div class="text-center mb-4 font-marvel">
                    <p class="text-gray-300">Game ID: <strong id="gameIdDisplay" class="text-yellow-400 cursor-pointer" title="Click to copy"></strong></p>
                    <p id="player-identity" class="font-bold text-xl"></p>
                </div>
                <div id="gameStatus" class="text-center text-3xl font-bangers tracking-wide mb-6 h-10"></div>
                
                <div id="player-board" class="player-board p-6 rounded-xl shadow-2xl">
                    <div class="flex justify-between items-center mb-4">
                        <h2 id="board-title" class="text-3xl font-bold font-marvel">Your Board</h2>
                        <button id="toggleViewBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg font-marvel">Toggle View</button>
                    </div>
                    
                    <!-- Role View Container -->
                    <div id="role-view" class="view-container">
                        <div>
                            <h3 class="text-2xl font-bangers text-yellow-400 tracking-wider mb-2">Vanguards</h3>
                            <div id="vanguard-grid" class="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-8 lg:grid-cols-10 gap-4"></div>
                        </div>
                        <div class="mt-6">
                            <h3 class="text-2xl font-bangers text-red-400 tracking-wider mb-2">Duelists</h3>
                            <div id="duelist-grid" class="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-8 lg:grid-cols-10 gap-4"></div>
                        </div>
                        <div class="mt-6">
                            <h3 class="text-2xl font-bangers text-sky-400 tracking-wider mb-2">Strategists</h3>
                            <div id="strategist-grid" class="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-8 lg:grid-cols-10 gap-4"></div>
                        </div>
                    </div>

                    <!-- Alphabetical View Container -->
                    <div id="alpha-view" class="view-container hidden">
                        <div id="alpha-grid" class="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-8 lg:grid-cols-10 gap-4"></div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8 pt-6 border-t-2 border-gray-700">
                        <div>
                            <h3 class="text-xl font-semibold text-center font-marvel">Your Mystery Character</h3>
                            <div id="player-mystery-card" class="mystery-card rounded-lg p-4 mt-2 flex items-center justify-center h-28"></div>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-center font-marvel">Opponent's Character</h3>
                            <div id="opponent-mystery-card" class="mystery-card rounded-lg p-4 mt-2 flex items-center justify-center h-28">
                                <span class="text-gray-500 text-2xl">?</span>
                            </div>
                        </div>
                    </div>
                    <div id="guess-area" class="mt-6 text-center hidden">
                        <h3 class="text-xl font-semibold font-marvel">Guess Opponent's Character:</h3>
                        <input type="text" id="guess-input" placeholder="Type name..." class="mt-2 w-full max-w-xs bg-gray-700 text-white border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-500 font-marvel">
                        <button id="guess-btn" class="ml-2 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105 font-marvel">Guess</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Generic Modal -->
    <div id="modal" class="modal-backdrop hidden">
        <div class="modal-content w-11/12 max-w-md">
            <h3 id="modal-title" class="text-2xl font-bold mb-4">Notification</h3>
            <p id="modal-text" class="mb-6">This is a message.</p>
            <div id="modal-buttons" class="flex justify-center gap-4"></div>
        </div>
    </div>

    <script type="module">
        
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CHARACTER DATA WITH IMAGES ---
        const characterImages = {
            'Adam Warlock': 'https://static.wikia.nocookie.net/marvel-rivals/images/7/7e/Adam_Warlock_Default_Costume_LoC_Icon.png',
            'Black Panther': 'https://static.wikia.nocookie.net/marvel-rivals/images/4/48/Black_Panther_Default_Costume_LoC_Icon.png',
            'Black Widow': 'https://static.wikia.nocookie.net/marvel-rivals/images/4/4f/Black_Widow_Default_Costume_LoC_Icon.png',
            'Blade': 'https://static.wikia.nocookie.net/marvel-rivals/images/a/a2/Blade_Default_Costume_LoC_Icon.png',
            'Hulk': 'https://static.wikia.nocookie.net/marvel-rivals/images/7/73/Bruce_Banner_Default_Costume_LoC_Icon.png',
            'Captain America': 'https://static.wikia.nocookie.net/marvel-rivals/images/5/5f/Captain_America_Default_Costume_LoC_Icon.png',
            'Cloak and Dagger': 'https://static.wikia.nocookie.net/marvel-rivals/images/1/15/Cloak_%26_Dagger_Default_Costume_LoC_Icon.png',
            'Doctor Strange': 'https://static.wikia.nocookie.net/marvel-rivals/images/0/07/Doctor_Strange_Default_Costume_LoC_Icon.png',
            'Emma Frost': 'https://static.wikia.nocookie.net/marvel-rivals/images/9/9b/Emma_Frost_Default_Costume_LoC_Icon.png',
            'Groot': 'https://static.wikia.nocookie.net/marvel-rivals/images/0/0a/Groot_Default_Costume_LoC_Icon.png',
            'Hawkeye': 'https://static.wikia.nocookie.net/marvel-rivals/images/c/c7/Hawkeye_Default_Costume_LoC_Icon.png',
            'Hela': 'https://static.wikia.nocookie.net/marvel-rivals/images/d/d1/Hela_Default_Costume_LoC_Icon.png',
            'Human Torch': 'https://static.wikia.nocookie.net/marvel-rivals/images/7/7a/Human_Torch_Default_Costume_LoC_Icon.png',
            'Invisible Woman': 'https://static.wikia.nocookie.net/marvel-rivals/images/3/3a/Invisible_Woman_Default_Costume_LoC_Icon.png',
            'Iron Fist': 'https://static.wikia.nocookie.net/marvel-rivals/images/9/9c/Iron_Fist_Default_Costume_LoC_Icon.png',
            'Iron Man': 'https://static.wikia.nocookie.net/marvel-rivals/images/c/c2/Iron_Man_Default_Costume_LoC_Icon.png',
            'Jeff the Land Shark': 'https://static.wikia.nocookie.net/marvel-rivals/images/1/13/Jeff_the_Land_Shark_Default_Costume_LoC_Icon.png',
            'Loki': 'https://static.wikia.nocookie.net/marvel-rivals/images/7/75/Loki_Default_Costume_LoC_Icon.png',
            'Luna Snow': 'https://static.wikia.nocookie.net/marvel-rivals/images/c/c9/Luna_Snow_Default_Costume_LoC_Icon.png',
            'Magik': 'https://static.wikia.nocookie.net/marvel-rivals/images/d/dd/Magik_Default_Costume_LoC_Icon.png',
            'Magneto': 'https://static.wikia.nocookie.net/marvel-rivals/images/d/d2/Magneto_Default_Costume_LoC_Icon.png',
            'Mantis': 'https://static.wikia.nocookie.net/marvel-rivals/images/3/3d/Mantis_Default_Costume_LoC_Icon.png',
            'Mister Fantastic': 'https://static.wikia.nocookie.net/marvel-rivals/images/4/40/Mister_Fantastic_Default_Costume_LoC_Icon.png',
            'Moon Knight': 'https://static.wikia.nocookie.net/marvel-rivals/images/f/ff/Moon_Knight_Default_Costume_LoC_Icon.png',
            'Namor': 'https://static.wikia.nocookie.net/marvel-rivals/images/7/7d/Namor_Default_Costume_LoC_Icon.png',
            'Peni Parker': 'https://static.wikia.nocookie.net/marvel-rivals/images/1/15/Peni_Parker_Default_Costume_LoC_Icon.png',
            'Phoenix': 'https://static.wikia.nocookie.net/marvel-rivals/images/d/de/Phoenix_Default_Costume_LoC_Icon.png',
            'Psylocke': 'https://static.wikia.nocookie.net/marvel-rivals/images/6/63/Psylocke_Default_Costume_LoC_Icon.png',
            'The Punisher': 'https://static.wikia.nocookie.net/marvel-rivals/images/1/15/The_Punisher_Default_Costume_LoC_Icon.png',
            'Rocket Raccoon': 'https://static.wikia.nocookie.net/marvel-rivals/images/d/d0/Rocket_Raccoon_Default_Costume_LoC_Icon.png',
            'Scarlet Witch': 'https://static.wikia.nocookie.net/marvel-rivals/images/e/ef/Scarlet_Witch_Default_Costume_LoC_Icon.png',
            'Spider-Man': 'https://static.wikia.nocookie.net/marvel-rivals/images/7/7a/Spider-Man_Default_Costume_LoC_Icon.png',
            'Squirrel Girl': 'https://static.wikia.nocookie.net/marvel-rivals/images/9/90/Squirrel_Girl_Default_Costume_LoC_Icon.png',
            'Star-Lord': 'https://static.wikia.nocookie.net/marvel-rivals/images/f/f9/Star-Lord_Default_Costume_LoC_Icon.png',
            'Storm': 'https://static.wikia.nocookie.net/marvel-rivals/images/1/16/Storm_Default_Costume_LoC_Icon.png',
            'The Thing': 'https://static.wikia.nocookie.net/marvel-rivals/images/e/e1/The_Thing_Default_Costume_LoC_Icon.png',
            'Thor': 'https://static.wikia.nocookie.net/marvel-rivals/images/0/02/Thor_Default_Costume_LoC_Icon.png',
            'Ultron': 'https://static.wikia.nocookie.net/marvel-rivals/images/5/5e/Ultron_Default_Costume_LoC_Icon.png',
            'Venom': 'https://static.wikia.nocookie.net/marvel-rivals/images/6/61/Venom_Default_Costume_LoC_Icon.png',
            'Winter Soldier': 'https://static.wikia.nocookie.net/marvel-rivals/images/0/05/Winter_Soldier_Default_Costume_LoC_Icon.png',
            'Wolverine': 'https://static.wikia.nocookie.net/marvel-rivals/images/f/f8/Wolverine_Default_Costume_LoC_Icon.png'
        };

        const characters = [
            { name: 'Captain America', role: 'Vanguard' }, { name: 'Doctor Strange', role: 'Vanguard' }, { name: 'Emma Frost', role: 'Vanguard' },
            { name: 'Groot', role: 'Vanguard' }, { name: 'Hulk', role: 'Vanguard' }, { name: 'Magneto', role: 'Vanguard' },
            { name: 'Peni Parker', role: 'Vanguard' }, { name: 'The Thing', role: 'Vanguard' }, { name: 'Thor', role: 'Vanguard' },
            { name: 'Venom', role: 'Vanguard' },
            { name: 'Black Panther', role: 'Duelist' }, { name: 'Black Widow', role: 'Duelist' }, { name: 'Blade', role: 'Duelist' },
            { name: 'Hawkeye', role: 'Duelist' }, { name: 'Hela', role: 'Duelist' }, { name: 'Human Torch', role: 'Duelist' }, 
            { name: 'Iron Fist', role: 'Duelist' }, { name: 'Iron Man', role: 'Duelist' }, { name: 'Magik', role: 'Duelist' }, 
            { name: 'Mister Fantastic', role: 'Duelist' }, { name: 'Moon Knight', role: 'Duelist' }, { name: 'Namor', role: 'Duelist' }, 
            { name: 'Phoenix', role: 'Duelist' }, { name: 'Psylocke', role: 'Duelist' }, { name: 'The Punisher', role: 'Duelist' }, 
            { name: 'Scarlet Witch', role: 'Duelist' }, { name: 'Squirrel Girl', role: 'Duelist' }, { name: 'Spider-Man', role: 'Duelist' }, 
            { name: 'Star-Lord', role: 'Duelist' }, { name: 'Storm', role: 'Duelist' }, { name: 'Winter Soldier', role: 'Duelist' }, 
            { name: 'Wolverine', role: 'Duelist' },
            { name: 'Adam Warlock', role: 'Strategist' }, { name: 'Cloak and Dagger', role: 'Strategist' }, { name: 'Invisible Woman', role: 'Strategist' },
            { name: 'Jeff the Land Shark', role: 'Strategist' }, { name: 'Loki', role: 'Strategist' }, { name: 'Luna Snow', role: 'Strategist' },
            { name: 'Mantis', role: 'Strategist' }, { name: 'Rocket Raccoon', role: 'Strategist' }, { name: 'Ultron', role: 'Strategist' }
        ];

        // --- GAME STATE & CONSTANTS ---
        let app, auth, db;
        let gameId = null;
        let playerNumber = null;
        let gameUnsubscribe = null;
        let localGameState = {};
        let currentView = 'role'; // 'role' or 'alpha'

        // --- DOM ELEMENTS ---
        const startScreen = document.getElementById('start-screen');
        const gameContainer = document.getElementById('game-container');
        const gameStatus = document.getElementById('gameStatus');
        const instructions = document.getElementById('instructions');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalText = document.getElementById('modal-text');
        const modalButtons = document.getElementById('modal-buttons');
        const playerBoard = document.getElementById('player-board');
        const toggleViewBtn = document.getElementById('toggleViewBtn');
        const roleView = document.getElementById('role-view');
        const alphaView = document.getElementById('alpha-view');

        // --- SOUND EFFECTS ---
        const winSound = new Tone.Synth({ oscillator: { type: "sine" } }).toDestination();
        const loseSound = new Tone.Synth({ oscillator: { type: "triangle" } }).toDestination();

        // --- INITIALIZATION ---
        async function initialize() {
            const firebaseConfig = {
                apiKey: "AIzaSyA3vaJjSDTQyEquEhWNaTlohdz9kZjjbeE",
                authDomain: "marvelrivalsgame-65cb4.firebaseapp.com",
                projectId: "marvelrivalsgame-65cb4",
                storageBucket: "marvelrivalsgame-65cb4.firebasestorage.app",
                messagingSenderId: "120750810065",
                appId: "1:120750810065:web:2cea63a26b1079fb7576f0",
                measurementId: "G-V00GNPDWPJ"
            };

            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Authentication failed:", error);
                showModal("Authentication Error", "Could not sign in. Please refresh the page.");
            }

            document.getElementById('createGameBtn').onclick = (e) => { e.preventDefault(); createNewGame(); };
            document.getElementById('joinGameBtn').onclick = (e) => { e.preventDefault(); joinGame(); };
            document.getElementById('gameIdDisplay').onclick = copyGameId;
            toggleViewBtn.onclick = toggleCharacterView;
        }

        // --- GAME FLOW ---
        async function createNewGame() {
            const newGameId = generateGameId();
            const gameRef = getGameRef(newGameId);
            const shuffledCharacters = [...characters].sort(() => 0.5 - Math.random());

            const initialGameState = {
                gameState: 'selection',
                currentPlayer: 1,
                player1: { id: auth.currentUser.uid, mysteryCharacter: null },
                player2: { id: null, mysteryCharacter: null },
                winner: null,
                characters: shuffledCharacters.map(c => c.name)
            };

            try {
                await setDoc(gameRef, initialGameState);
                await setupGameSession(newGameId, 1);
            } catch (error) {
                console.error("Error creating game:", error);
                showModal("Error", "Could not create the game. Please try again.");
            }
        }

        async function joinGame() {
            const gameIdToJoin = document.getElementById('gameIdInput').value.trim().toUpperCase();
            if (!gameIdToJoin) {
                showModal("Input Required", "Please enter a Game ID.");
                return;
            }

            const gameRef = getGameRef(gameIdToJoin);
            const gameDoc = await getDoc(gameRef);

            if (!gameDoc.exists()) {
                showModal("Error", "Game not found. Please check the ID and try again.");
                return;
            }

            const gameData = gameDoc.data();
            const myUid = auth.currentUser.uid;

            if (gameData.player1.id === myUid) {
                if (!gameData.player2.id) {
                    showModal("You are Player 1", "You have already created this game. To play, ask a friend to join this game ID from their own device or a different browser profile (like an Incognito window).");
                }
                await setupGameSession(gameIdToJoin, 1);
                return;
            }

            if (gameData.player2.id && gameData.player2.id !== myUid) {
                showModal("Game Full", "This game already has two players.");
                return;
            }

            await updateDoc(gameRef, { 'player2.id': myUid });
            await setupGameSession(gameIdToJoin, 2);
        }

        function setupGameSession(newGameId, pNum) {
            gameId = newGameId;
            playerNumber = pNum;

            startScreen.classList.add('hidden');
            gameContainer.classList.remove('hidden');
            document.getElementById('gameIdDisplay').textContent = gameId;

            const playerIdentity = document.getElementById('player-identity');
            playerIdentity.textContent = `You are Player ${playerNumber}`;
            playerIdentity.className = `font-bold text-xl ${playerNumber === 1 ? 'text-yellow-400' : 'text-red-400'}`;

            if (gameUnsubscribe) gameUnsubscribe();
            gameUnsubscribe = onSnapshot(getGameRef(gameId), handleGameStateUpdate);
        }

        // --- REAL-TIME STATE HANDLER ---
        function handleGameStateUpdate(doc) {
            if (!doc.exists()) {
                showModal("Game Error", "The game session has ended or could not be found.", true);
                return;
            }
            const oldGameState = localGameState.gameState;
            localGameState = doc.data();
            
            const vanguardGrid = document.getElementById('vanguard-grid');
            if (vanguardGrid.children.length === 0 && localGameState.characters) {
                 const characterList = localGameState.characters.map(name => characters.find(c => c.name === name));
                 populateAllGrids(characterList);
            }

            updateUIFromState();

            if (oldGameState !== 'gameover' && localGameState.gameState === 'gameover') {
                showEndGameModal();
            }
        }

        // --- UI UPDATES ---
        function updateUIFromState() {
            const { gameState, currentPlayer, winner, player1, player2 } = localGameState;
            
            playerBoard.classList.remove('active', 'active-p2');
            if (gameState === 'gameplay' && currentPlayer === playerNumber) {
                 playerBoard.classList.add(playerNumber === 1 ? 'active' : 'active-p2');
            }
            
            if (gameState === 'selection') {
                if ((playerNumber === 1 && !player1.mysteryCharacter) || (playerNumber === 2 && !player2.mysteryCharacter)) {
                    instructions.textContent = "Please choose your secret character from the board below.";
                } else {
                    instructions.textContent = "Waiting for your opponent to choose their character...";
                }
                gameStatus.textContent = '';
            } else if (gameState === 'gameplay') {
                instructions.textContent = "Ask yes/no questions to guess your opponent's mystery character.";
                gameStatus.textContent = `Player ${currentPlayer}'s Turn`;
                gameStatus.className = `text-center text-3xl font-bangers tracking-wide mb-6 h-10 ${currentPlayer === 1 ? 'text-yellow-400' : 'text-red-400'}`;
                document.getElementById('guess-area').classList.remove('hidden');
            } else if (gameState === 'gameover') {
                instructions.textContent = "Game Over! Click the button below to play again.";
                gameStatus.textContent = `Player ${winner} wins!`;
                gameStatus.className = 'text-center text-4xl font-bangers tracking-wider mb-6 h-10 text-green-400';
                document.getElementById('guess-area').classList.add('hidden');
            }

            const myCharName = playerNumber === 1 ? player1.mysteryCharacter : player2.mysteryCharacter;
            if (myCharName) {
                const myChar = characters.find(c => c.name === myCharName);
                if(myChar) displayMysteryCard('player-mystery-card', myChar);
            }
        }
        
        function populateAllGrids(charList) {
            const vanguardGrid = document.getElementById('vanguard-grid');
            const duelistGrid = document.getElementById('duelist-grid');
            const strategistGrid = document.getElementById('strategist-grid');
            const alphaGrid = document.getElementById('alpha-grid');

            vanguardGrid.innerHTML = '';
            duelistGrid.innerHTML = '';
            strategistGrid.innerHTML = '';
            alphaGrid.innerHTML = '';

            charList.forEach(char => {
                if (!char) return;
                const card = createCharacterCard(char);
                if (char.role === 'Vanguard') vanguardGrid.appendChild(card.cloneNode(true));
                else if (char.role === 'Duelist') duelistGrid.appendChild(card.cloneNode(true));
                else if (char.role === 'Strategist') strategistGrid.appendChild(card.cloneNode(true));
            });
            
            document.querySelectorAll('#role-view .character-card').forEach(card => {
                const charName = card.dataset.charName;
                const char = characters.find(c => c.name === charName);
                card.onclick = () => handleCardClick(char, card);
            });

            [...charList].sort((a, b) => a.name.localeCompare(b.name)).forEach(char => {
                 if (!char) return;
                 alphaGrid.appendChild(createCharacterCard(char));
            });

            document.querySelectorAll('#alpha-view .character-card').forEach(card => {
                const charName = card.dataset.charName;
                const char = characters.find(c => c.name === charName);
                card.onclick = () => handleCardClick(char, card);
            });
        }

        function createCharacterCard(char) {
            const card = document.createElement('div');
            card.className = 'character-card bg-gray-700 rounded-lg p-2 text-center shadow-md';
            card.dataset.charName = char.name;
            
            // Get the real character image URL or fallback to placeholder
            const primaryImageUrl = characterImages[char.name];
            const proxiedImageUrl = primaryImageUrl ? `https://images.weserv.nl/?url=${encodeURIComponent(primaryImageUrl)}&w=100&h=100&fit=contain&trim=10` : null;
            const fallbackImageUrl = `https://placehold.co/100x100/1f2937/fef2f2?text=${encodeURIComponent(char.name.replace(' ', '%0A'))}`;
            
            card.innerHTML = `
                <img src="${proxiedImageUrl || fallbackImageUrl}" 
                     alt="${char.name}" 
                     class="w-full h-auto rounded-md mx-auto pointer-events-none character-image" 
                     style="max-height: 100px; object-fit: contain;"
                     onerror="this.onerror=null; this.src='${fallbackImageUrl}'; console.log('Failed to load image for ${char.name}');">
                <p class="mt-2 text-xs font-semibold truncate pointer-events-none">${char.name}</p>
            `;
            return card;
        }

        function displayMysteryCard(elementId, character) {
            const container = document.getElementById(elementId);
            container.innerHTML = `
                <div class="text-center">
                    <p class="text-lg font-bold text-yellow-400">${character.name}</p>
                    <p class="text-xs text-gray-400">(${character.role})</p>
                </div>
            `;
        }

        // --- PLAYER ACTIONS & UI ---
        function toggleCharacterView() {
            if (currentView === 'role') {
                currentView = 'alpha';
                roleView.classList.add('hidden');
                alphaView.classList.remove('hidden');
            } else {
                currentView = 'role';
                roleView.classList.remove('hidden');
                alphaView.classList.add('hidden');
            }
        }

        function handleCardClick(character, cardElement) {
            if (localGameState.gameState === 'selection') {
                const myCharacter = playerNumber === 1 ? localGameState.player1.mysteryCharacter : localGameState.player2.mysteryCharacter;
                if (myCharacter) {
                    showModal("Already Chosen", "You have already selected your character.");
                    return;
                }
                showConfirmationModal(character);
            } else if (localGameState.gameState === 'gameplay') {
                const allCards = document.querySelectorAll(`.character-card[data-char-name="${character.name}"]`);
                allCards.forEach(card => card.classList.toggle('flipped'));
            }
        }

        async function confirmSelection(character) {
            const gameRef = getGameRef(gameId);
            const updateData = {};
            if (playerNumber === 1) {
                updateData['player1.mysteryCharacter'] = character.name;
            } else {
                updateData['player2.mysteryCharacter'] = character.name;
            }

            const opponentChar = playerNumber === 1 ? localGameState.player2.mysteryCharacter : localGameState.player1.mysteryCharacter;
            if (opponentChar) {
                updateData.gameState = 'gameplay';
            }
            
            await updateDoc(gameRef, updateData);
        }

        async function handleGuess() {
            const { gameState, currentPlayer } = localGameState;
            if (gameState !== 'gameplay' || currentPlayer !== playerNumber) {
                showModal("Not Your Turn", "It's not your turn to guess.");
                return;
            }

            const guessInput = document.getElementById('guess-input');
            const guess = guessInput.value.trim();
            if (!guess) {
                showModal("Input Required", "Please enter a character's name.");
                return;
            }

            const opponentCharName = (playerNumber === 1) ? localGameState.player2.mysteryCharacter : localGameState.player1.mysteryCharacter;
            const gameRef = getGameRef(gameId);

            // Find the closest matching character
            const matchedCharacter = findClosestCharacterMatch(guess);
            
            if (!matchedCharacter) {
                showModal("Character Not Found", `"${guess}" is not a valid Marvel Rivals character. Please check the spelling and try again.`);
                return;
            }

            // If the matched character is different from what was typed, confirm with user
            if (matchedCharacter.name.toLowerCase() !== guess.toLowerCase()) {
                showSpellCheckModal(matchedCharacter, opponentCharName, gameRef);
                guessInput.value = '';
                return;
            }

            // Process the guess
            if (matchedCharacter.name === opponentCharName) {
                await updateDoc(gameRef, { gameState: 'gameover', winner: playerNumber });
            } else {
                showModal("Incorrect Guess!", "That was not the correct character. Your turn is over.");
                await updateDoc(gameRef, { currentPlayer: playerNumber === 1 ? 2 : 1 });
            }
            guessInput.value = '';
        }
        
        document.getElementById('guess-btn').onclick = handleGuess;

        // --- UTILITIES ---
        function getGameRef(id) {
            return doc(db, "guess-who-games", id);
        }

        function generateGameId() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        // Spell check function to find closest character match
        function findClosestCharacterMatch(guess) {
            const normalizedGuess = guess.toLowerCase().trim();
            
            // First, check for exact match
            const exactMatch = characters.find(char => char.name.toLowerCase() === normalizedGuess);
            if (exactMatch) return exactMatch;
            
            // Check for partial matches (contains or is contained)
            const partialMatch = characters.find(char => {
                const charName = char.name.toLowerCase();
                return charName.includes(normalizedGuess) || normalizedGuess.includes(charName);
            });
            if (partialMatch) return partialMatch;
            
            // Check for matches ignoring common variations
            const cleanGuess = normalizedGuess.replace(/[^a-z0-9]/g, '');
            const cleanMatch = characters.find(char => {
                const cleanCharName = char.name.toLowerCase().replace(/[^a-z0-9]/g, '');
                return cleanCharName === cleanGuess;
            });
            if (cleanMatch) return cleanMatch;
            
            // Check for simple misspellings using Levenshtein distance
            let bestMatch = null;
            let bestDistance = Infinity;
            
            characters.forEach(char => {
                const distance = levenshteinDistance(normalizedGuess, char.name.toLowerCase());
                const maxAllowedDistance = Math.max(1, Math.floor(char.name.length * 0.3)); // Allow 30% error
                
                if (distance <= maxAllowedDistance && distance < bestDistance) {
                    bestDistance = distance;
                    bestMatch = char;
                }
            });
            
            return bestMatch;
        }

        // Simple Levenshtein distance calculation
        function levenshteinDistance(str1, str2) {
            const matrix = [];
            
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1, // substitution
                            matrix[i][j - 1] + 1,     // insertion
                            matrix[i - 1][j] + 1      // deletion
                        );
                    }
                }
            }
            
            return matrix[str2.length][str1.length];
        }
        
        function copyGameId() {
            navigator.clipboard.writeText(gameId).then(() => {
                showModal("Copied!", `Game ID ${gameId} has been copied to your clipboard.`);
            }, () => {
                showModal("Copy Failed", "Could not copy the Game ID.");
            });
        }

        function showModal(title, text) {
            modal.classList.remove('hidden');
            modalTitle.textContent = title;
            modalTitle.className = "text-2xl font-bold mb-4";
            modalText.textContent = text;
            modalButtons.innerHTML = '';

            const okButton = document.createElement('button');
            okButton.textContent = 'OK';
            okButton.className = 'bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-8 rounded-lg';
            okButton.onclick = () => modal.classList.add('hidden');
            modalButtons.appendChild(okButton);
        }

        function showEndGameModal() {
            const { winner, player1, player2 } = localGameState;
            const playerWon = winner === playerNumber;
            const now = Tone.now();

            if (playerWon) {
                modalTitle.textContent = "You Win!";
                modalTitle.className = "text-4xl font-bangers text-green-400";
                winSound.triggerAttackRelease("C4", "8n", now);
                winSound.triggerAttackRelease("E4", "8n", now + 0.2);
                winSound.triggerAttackRelease("G4", "8n", now + 0.4);
            } else {
                modalTitle.textContent = "You Lose!";
                modalTitle.className = "text-4xl font-bangers text-red-500";
                loseSound.triggerAttackRelease("G3", "4n", now);
                loseSound.triggerAttackRelease("C3", "2n", now + 0.2);
            }

            const opponentCharName = playerNumber === 1 ? player2.mysteryCharacter : player1.mysteryCharacter;
            modalText.textContent = `Your opponent's character was ${opponentCharName}.`;
            modalButtons.innerHTML = '';

            const playAgainButton = document.createElement('button');
            playAgainButton.textContent = 'Play Again';
            playAgainButton.className = 'mode-link-box';
            playAgainButton.onclick = () => window.location.reload();
            
            modalButtons.appendChild(playAgainButton);
            modal.classList.remove('hidden');
        }

        function showConfirmationModal(character) {
            modal.classList.remove('hidden');
            modalTitle.textContent = "Confirm Selection";
            modalTitle.className = "text-2xl font-bold mb-4";
            modalText.textContent = `Do you want to choose ${character.name}?`;
            modalButtons.innerHTML = '';
            
            const yesButton = document.createElement('button');
            yesButton.textContent = 'Yes';
            yesButton.className = 'bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg';
            yesButton.onclick = () => {
                confirmSelection(character);
                modal.classList.add('hidden');
            };

            const noButton = document.createElement('button');
            noButton.textContent = 'No';
            noButton.className = 'bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg';
            noButton.onclick = () => modal.classList.add('hidden');

            modalButtons.appendChild(yesButton);
            modalButtons.appendChild(noButton);
        }

        async function showSpellCheckModal(matchedCharacter, opponentCharName, gameRef) {
            modal.classList.remove('hidden');
            modalTitle.textContent = "Did you mean...?";
            modalTitle.className = "text-2xl font-bold mb-4";
            modalText.textContent = `Did you mean "${matchedCharacter.name}"?`;
            modalButtons.innerHTML = '';
            
            const yesButton = document.createElement('button');
            yesButton.textContent = 'Yes, guess that';
            yesButton.className = 'bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg';
            yesButton.onclick = async () => {
                modal.classList.add('hidden');
                
                // Process the corrected guess
                if (matchedCharacter.name === opponentCharName) {
                    await updateDoc(gameRef, { gameState: 'gameover', winner: playerNumber });
                } else {
                    showModal("Incorrect Guess!", "That was not the correct character. Your turn is over.");
                    await updateDoc(gameRef, { currentPlayer: playerNumber === 1 ? 2 : 1 });
                }
            };

            const noButton = document.createElement('button');
            noButton.textContent = 'No, try again';
            noButton.className = 'bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg';
            noButton.onclick = () => {
                modal.classList.add('hidden');
                // Focus back on the input for the user to try again
                document.getElementById('guess-input').focus();
            };

            modalButtons.appendChild(yesButton);
            modalButtons.appendChild(noButton);
        }

        // --- START THE APP ---
        initialize();
    </script>
</body>
</html>
