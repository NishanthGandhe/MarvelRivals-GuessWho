<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marvel Rivals - Guess Who?</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .character-card {
            transition: transform 0.3s, filter 0.3s, opacity 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }
        .character-card:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.5);
        }
        .character-card.flipped {
            transform: scale(0.9);
            filter: grayscale(100%);
            opacity: 0.5;
        }
        .mystery-card { border: 2px dashed #4a5568; }
        .neon-text {
            text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 20px #0ea5e9, 0 0 30px #0ea5e9, 0 0 40px #0ea5e9;
        }
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7); display: flex;
            justify-content: center; align-items: center; z-index: 100;
        }
        .modal-content {
            background-color: #2d3748; padding: 2rem; border-radius: 0.75rem;
            text-align: center; border: 1px solid #4a5568; box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        #game-container.hidden, #start-screen.hidden, .modal-backdrop.hidden { display: none; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <div class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold neon-text">Marvel Rivals: Guess Who?</h1>
            <p id="instructions" class="text-gray-400 mt-2">Create or join a game to start playing!</p>
        </div>

        <!-- Start Screen -->
        <div id="start-screen" class="bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700 text-center">
            <button id="createGameBtn" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-8 text-lg rounded-lg shadow-lg transition-transform transform hover:scale-105">Create New Game</button>
            <div class="my-6 text-gray-400">OR</div>
            <div>
                <input type="text" id="gameIdInput" placeholder="Enter Game ID to Join" class="w-full max-w-xs bg-gray-700 text-white border border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-sky-500">
                <button id="joinGameBtn" class="ml-2 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105">Join Game</button>
            </div>
        </div>

        <!-- Game Container -->
        <div id="game-container" class="hidden">
            <div class="text-center mb-4">
                <p class="text-gray-400">Game ID: <strong id="gameIdDisplay" class="text-yellow-400 cursor-pointer" title="Click to copy"></strong></p>
                <p id="player-identity" class="font-bold text-xl"></p>
            </div>
            <div id="gameStatus" class="text-center text-2xl font-semibold mb-6 h-8"></div>
            
            <div class="player-board bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700">
                <h2 id="board-title" class="text-3xl font-bold text-center mb-4">Your Board</h2>
                <div id="player-grid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-4"></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div>
                        <h3 class="text-xl font-semibold text-center">Your Mystery Character</h3>
                        <div id="player-mystery-card" class="mystery-card bg-gray-900 rounded-lg p-4 mt-2 flex items-center justify-center h-28"></div>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold text-center">Opponent's Character</h3>
                        <div id="opponent-mystery-card" class="mystery-card bg-gray-900 rounded-lg p-4 mt-2 flex items-center justify-center h-28">
                            <span class="text-gray-500 text-2xl">?</span>
                        </div>
                    </div>
                </div>
                <div id="guess-area" class="mt-6 text-center hidden">
                    <h3 class="text-xl font-semibold">Guess Opponent's Character:</h3>
                    <input type="text" id="guess-input" placeholder="Type name..." class="mt-2 w-full max-w-xs bg-gray-700 text-white border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                    <button id="guess-btn" class="ml-2 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105">Guess</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Generic Modal -->
    <div id="modal" class="modal-backdrop hidden">
        <div class="modal-content w-11/12 max-w-md">
            <h3 id="modal-title" class="text-2xl font-bold mb-4">Notification</h3>
            <p id="modal-text" class="mb-6">This is a message.</p>
            <div id="modal-buttons" class="flex justify-center gap-4">
                <button id="modal-ok" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-8 rounded-lg">OK</button>
            </div>
        </div>
    </div>

    <script type="module">
        
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CHARACTER DATA ---
        const characters = [
            { name: 'Hulk', role: 'Vanguard', gender: 'Male', isHuman: true, wearsMask: false, hasWeapon: false, isCosmic: false, isMutant: false, fromEarth: true },
            { name: 'Doctor Strange', role: 'Vanguard', gender: 'Male', isHuman: true, wearsMask: false, hasWeapon: false, isCosmic: true, isMutant: false, fromEarth: true },
            { name: 'Magneto', role: 'Vanguard', gender: 'Male', isHuman: false, wearsMask: true, hasWeapon: false, isCosmic: false, isMutant: true, fromEarth: true },
            { name: 'Black Panther', role: 'Duelist', gender: 'Male', isHuman: true, wearsMask: true, hasWeapon: false, isCosmic: false, isMutant: false, fromEarth: true },
            { name: 'Hela', role: 'Duelist', gender: 'Female', isHuman: false, wearsMask: true, hasWeapon: true, isCosmic: true, isMutant: false, fromEarth: false },
            { name: 'Iron Man', role: 'Duelist', gender: 'Male', isHuman: true, wearsMask: true, hasWeapon: false, isCosmic: false, isMutant: false, fromEarth: true },
            { name: 'Luna Snow', role: 'Strategist', gender: 'Female', isHuman: true, wearsMask: false, hasWeapon: false, isCosmic: false, isMutant: false, fromEarth: true },
            { name: 'Magik', role: 'Duelist', gender: 'Female', isHuman: false, wearsMask: false, hasWeapon: true, isCosmic: false, isMutant: true, fromEarth: true },
            { name: 'Mantis', role: 'Strategist', gender: 'Female', isHuman: false, wearsMask: false, hasWeapon: false, isCosmic: true, isMutant: false, fromEarth: false },
            { name: 'Loki', role: 'Strategist', gender: 'Male', isHuman: false, wearsMask: true, hasWeapon: true, isCosmic: true, isMutant: false, fromEarth: false },
            { name: 'Namor', role: 'Duelist', gender: 'Male', isHuman: false, wearsMask: false, hasWeapon: true, isCosmic: false, isMutant: true, fromEarth: true },
            { name: 'Captain America', role: 'Vanguard', gender: 'Male', isHuman: true, wearsMask: true, hasWeapon: true, isCosmic: false, isMutant: false, fromEarth: true },
            { name: 'Rocket Raccoon', role: 'Strategist', gender: 'Male', isHuman: false, wearsMask: false, hasWeapon: true, isCosmic: true, isMutant: false, fromEarth: false },
            { name: 'Spider-Man', role: 'Duelist', gender: 'Male', isHuman: true, wearsMask: true, hasWeapon: false, isCosmic: false, isMutant: false, fromEarth: true },
            { name: 'Hawkeye', role: 'Duelist', gender: 'Male', isHuman: true, wearsMask: false, hasWeapon: true, isCosmic: false, isMutant: false, fromEarth: true },
            { name: 'Peni Parker', role: 'Vanguard', gender: 'Female', isHuman: true, wearsMask: false, hasWeapon: false, isCosmic: false, isMutant: false, fromEarth: true },
            { name: 'Moon Knight', role: 'Duelist', gender: 'Male', isHuman: true, wearsMask: true, hasWeapon: true, isCosmic: false, isMutant: false, fromEarth: true },
            { name: 'Scarlet Witch', role: 'Duelist', gender: 'Female', isHuman: false, wearsMask: false, hasWeapon: false, isCosmic: false, isMutant: true, fromEarth: true },
            { name: 'Adam Warlock', role: 'Strategist', gender: 'Male', isHuman: false, wearsMask: false, hasWeapon: false, isCosmic: true, isMutant: false, fromEarth: false },
            { name: 'Iron Fist', role: 'Duelist', gender: 'Male', isHuman: true, wearsMask: false, hasWeapon: false, isCosmic: false, isMutant: false, fromEarth: true },
            { name: 'The Punisher', role: 'Duelist', gender: 'Male', isHuman: true, wearsMask: false, hasWeapon: true, isCosmic: false, isMutant: false, fromEarth: true },
            { name: 'Storm', role: 'Duelist', gender: 'Female', isHuman: false, wearsMask: false, hasWeapon: false, isCosmic: false, isMutant: true, fromEarth: true },
            { name: 'Venom', role: 'Vanguard', gender: 'Male', isHuman: false, wearsMask: true, hasWeapon: false, isCosmic: true, isMutant: false, fromEarth: false },
            { name: 'Winter Soldier', role: 'Duelist', gender: 'Male', isHuman: true, wearsMask: true, hasWeapon: true, isCosmic: false, isMutant: false, fromEarth: true },
            { name: 'Wolverine', role: 'Duelist', gender: 'Male', isHuman: false, wearsMask: true, hasWeapon: false, isCosmic: false, isMutant: true, fromEarth: true }
        ];

        // --- FIREBASE & GAME STATE ---
        let app, auth, db;
        let gameId = null;
        let playerNumber = null;
        let gameUnsubscribe = null; // To detach the Firestore listener
        let localGameState = {};

        // --- DOM ELEMENTS ---
        const startScreen = document.getElementById('start-screen');
        const gameContainer = document.getElementById('game-container');
        const playerGrid = document.getElementById('player-grid');
        const gameStatus = document.getElementById('gameStatus');
        const instructions = document.getElementById('instructions');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalText = document.getElementById('modal-text');
        const modalButtons = document.getElementById('modal-buttons');

        // --- INITIALIZATION ---
        async function initialize() {
            const firebaseConfig = {
                apiKey: "AIzaSyA3vaJjSDTQyEquEhWNaTlohdz9kZjjbeE",
                authDomain: "marvelrivalsgame-65cb4.firebaseapp.com",
                projectId: "marvelrivalsgame-65cb4",
                storageBucket: "marvelrivalsgame-65cb4.firebasestorage.app",
                messagingSenderId: "120750810065",
                appId: "1:120750810065:web:2cea63a26b1079fb7576f0",
                measurementId: "G-V00GNPDWPJ"
            };

            // Initialize Firebase
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            try {
                // Since you're not in the special environment, always sign in anonymously.
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Authentication failed:", error);
                showModal("Authentication Error", "Could not sign in. Please refresh the page.");
            }

            document.getElementById('createGameBtn').onclick = createNewGame;
            document.getElementById('joinGameBtn').onclick = joinGame;
            document.getElementById('gameIdDisplay').onclick = copyGameId;
        }

        // --- GAME FLOW ---
        async function createNewGame() {
            const newGameId = generateGameId();
            const gameRef = getGameRef(newGameId);
            const shuffledCharacters = [...characters].sort(() => 0.5 - Math.random());

            const initialGameState = {
                gameState: 'selection', // 'selection', 'gameplay', 'gameover'
                currentPlayer: 1,
                player1: { id: auth.currentUser.uid, mysteryCharacter: null },
                player2: { id: null, mysteryCharacter: null },
                winner: null,
                characters: shuffledCharacters.map(c => c.name) // Store the shuffled order
            };

            try {
                await setDoc(gameRef, initialGameState);
                await setupGameSession(newGameId, 1);
            } catch (error) {
                console.error("Error creating game:", error);
                showModal("Error", "Could not create the game. Please try again.");
            }
        }

        async function joinGame() {
            const gameIdToJoin = document.getElementById('gameIdInput').value.trim();
            if (!gameIdToJoin) {
                showModal("Input Required", "Please enter a Game ID.");
                return;
            }

            const gameRef = getGameRef(gameIdToJoin);
            const gameDoc = await getDoc(gameRef);

            if (!gameDoc.exists()) {
                showModal("Error", "Game not found. Please check the ID and try again.");
                return;
            }

            const gameData = gameDoc.data();
            if (gameData.player2.id && gameData.player2.id !== auth.currentUser.uid) {
                showModal("Game Full", "This game already has two players.");
                return;
            }

            if (gameData.player1.id !== auth.currentUser.uid) {
                await updateDoc(gameRef, { 'player2.id': auth.currentUser.uid });
                await setupGameSession(gameIdToJoin, 2);
            } else {
                // Player 1 is rejoining
                await setupGameSession(gameIdToJoin, 1);
            }
        }

        function setupGameSession(newGameId, pNum) {
            gameId = newGameId;
            playerNumber = pNum;

            startScreen.classList.add('hidden');
            gameContainer.classList.remove('hidden');
            document.getElementById('gameIdDisplay').textContent = gameId;

            const playerIdentity = document.getElementById('player-identity');
            playerIdentity.textContent = `You are Player ${playerNumber}`;
            playerIdentity.className = `font-bold text-xl ${playerNumber === 1 ? 'text-sky-400' : 'text-red-400'}`;

            if (gameUnsubscribe) gameUnsubscribe(); // Unsubscribe from any previous listener
            gameUnsubscribe = onSnapshot(getGameRef(gameId), handleGameStateUpdate);
        }

        // --- REAL-TIME STATE HANDLER ---
        function handleGameStateUpdate(doc) {
            if (!doc.exists()) {
                showModal("Game Error", "The game session has ended or could not be found.", true);
                return;
            }
            localGameState = doc.data();
            
            // Populate board on first load
            if (playerGrid.children.length === 0) {
                 const characterList = localGameState.characters.map(name => characters.find(c => c.name === name));
                 populateGrid(playerGrid, characterList);
            }

            updateUIFromState();
        }

        // --- UI UPDATES ---
        function updateUIFromState() {
            const { gameState, currentPlayer, winner, player1, player2 } = localGameState;
            
            // Update status text
            if (gameState === 'selection') {
                if ((playerNumber === 1 && !player1.mysteryCharacter) || (playerNumber === 2 && !player2.mysteryCharacter)) {
                    instructions.textContent = "Please choose your secret character from the board below.";
                } else {
                    instructions.textContent = "Waiting for your opponent to choose their character...";
                }
                gameStatus.textContent = '';
            } else if (gameState === 'gameplay') {
                instructions.textContent = "Ask yes/no questions to guess your opponent's mystery character.";
                gameStatus.textContent = `Player ${currentPlayer}'s Turn`;
                gameStatus.className = `text-center text-2xl font-semibold mb-6 h-8 ${currentPlayer === 1 ? 'text-sky-400' : 'text-red-400'}`;
                document.getElementById('guess-area').classList.remove('hidden');
            } else if (gameState === 'gameover') {
                instructions.textContent = "Game Over! Click the Game ID to copy it and start a new game.";
                gameStatus.textContent = `Player ${winner} wins!`;
                gameStatus.className = 'text-center text-3xl font-bold mb-6 h-8 text-green-400 neon-text';
                document.getElementById('guess-area').classList.add('hidden');
                
                // Reveal opponent's card
                const opponentCharName = playerNumber === 1 ? player2.mysteryCharacter : player1.mysteryCharacter;
                const opponentChar = characters.find(c => c.name === opponentCharName);
                if(opponentChar) displayMysteryCard('opponent-mystery-card', opponentChar);
            }

            // Display your chosen character
            const myCharName = playerNumber === 1 ? player1.mysteryCharacter : player2.mysteryCharacter;
            if (myCharName) {
                const myChar = characters.find(c => c.name === myCharName);
                if(myChar) displayMysteryCard('player-mystery-card', myChar);
            }
        }
        
        function populateGrid(gridElement, charList) {
            gridElement.innerHTML = ''; // Clear existing grid
            charList.forEach(char => {
                const card = document.createElement('div');
                card.className = 'character-card bg-gray-700 rounded-lg p-2 text-center shadow-md';
                card.dataset.charName = char.name;
                card.innerHTML = `
                    <img src="https://placehold.co/100x100/2d3748/e2e8f0?text=${char.name.split(' ').join('%0A')}" alt="${char.name}" class="w-full h-auto rounded-md mx-auto pointer-events-none">
                    <p class="mt-2 text-sm font-semibold truncate pointer-events-none">${char.name}</p>
                `;
                card.onclick = () => handleCardClick(char, card);
                gridElement.appendChild(card);
            });
        }

        function displayMysteryCard(elementId, character) {
            const container = document.getElementById(elementId);
            container.innerHTML = `
                <div class="text-center">
                    <p class="text-lg font-bold text-yellow-400">${character.name}</p>
                    <p class="text-xs text-gray-400">(${character.role})</p>
                </div>
            `;
        }

        // --- PLAYER ACTIONS ---
        function handleCardClick(character, cardElement) {
            const { gameState, player1, player2 } = localGameState;
            if (gameState === 'selection') {
                const myCharacter = playerNumber === 1 ? player1.mysteryCharacter : player2.mysteryCharacter;
                if (myCharacter) {
                    showModal("Already Chosen", "You have already selected your character.");
                    return;
                }
                showConfirmationModal(character);
            } else if (gameState === 'gameplay') {
                cardElement.classList.toggle('flipped');
            }
        }

        async function confirmSelection(character) {
            const gameRef = getGameRef(gameId);
            const updateData = {};
            if (playerNumber === 1) {
                updateData['player1.mysteryCharacter'] = character.name;
            } else {
                updateData['player2.mysteryCharacter'] = character.name;
            }

            // If both players have now chosen, start the game
            const opponentChar = playerNumber === 1 ? localGameState.player2.mysteryCharacter : localGameState.player1.mysteryCharacter;
            if (opponentChar) {
                updateData.gameState = 'gameplay';
            }
            
            await updateDoc(gameRef, updateData);
        }

        async function handleGuess() {
            const { gameState, currentPlayer, player1, player2 } = localGameState;
            if (gameState !== 'gameplay' || currentPlayer !== playerNumber) {
                showModal("Not Your Turn", "It's not your turn to guess.");
                return;
            }

            const guessInput = document.getElementById('guess-input');
            const guess = guessInput.value.trim().toLowerCase();
            if (!guess) {
                showModal("Input Required", "Please enter a character's name.");
                return;
            }

            const opponentCharName = (playerNumber === 1) ? player2.mysteryCharacter : player1.mysteryCharacter;
            const gameRef = getGameRef(gameId);

            if (guess === opponentCharName.toLowerCase()) {
                await updateDoc(gameRef, { gameState: 'gameover', winner: playerNumber });
            } else {
                showModal("Incorrect Guess!", "That was not the correct character. Your turn is over.");
                await updateDoc(gameRef, { currentPlayer: playerNumber === 1 ? 2 : 1 });
            }
            guessInput.value = '';
        }
        
        document.getElementById('guess-btn').onclick = handleGuess;

        // --- UTILITIES ---
        function getGameRef(id) {
            // This is the corrected line:
            const appId = 'marvel-guess-who'; 
            return doc(db, `artifacts/${appId}/public/data/guess-who-games`, id);
        }

        function generateGameId() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }
        
        function copyGameId() {
            navigator.clipboard.writeText(gameId).then(() => {
                showModal("Copied!", `Game ID ${gameId} has been copied to your clipboard.`);
            }, () => {
                showModal("Copy Failed", "Could not copy the Game ID.");
            });
        }

        function showModal(title, text, isError = false) {
            modal.classList.remove('hidden');
            modalTitle.textContent = title;
            modalText.textContent = text;
            modalButtons.innerHTML = ''; // Clear previous buttons

            const okButton = document.createElement('button');
            okButton.textContent = 'OK';
            okButton.className = 'bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-8 rounded-lg';
            okButton.onclick = () => {
                modal.classList.add('hidden');
                if (isError) { // If it's a fatal error, reset to start screen
                    gameContainer.classList.add('hidden');
                    startScreen.classList.remove('hidden');
                    if(gameUnsubscribe) gameUnsubscribe();
                }
            };
            modalButtons.appendChild(okButton);
        }

        function showConfirmationModal(character) {
            modal.classList.remove('hidden');
            modalTitle.textContent = "Confirm Selection";
            modalText.textContent = `Do you want to choose ${character.name}?`;
            modalButtons.innerHTML = '';
            
            const yesButton = document.createElement('button');
            yesButton.textContent = 'Yes';
            yesButton.className = 'bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg';
            yesButton.onclick = () => {
                confirmSelection(character);
                modal.classList.add('hidden');
            };

            const noButton = document.createElement('button');
            noButton.textContent = 'No';
            noButton.className = 'bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg';
            noButton.onclick = () => modal.classList.add('hidden');

            modalButtons.appendChild(yesButton);
            modalButtons.appendChild(noButton);
        }

        // --- START THE APP ---
        initialize();
    </script>
</body>
</html>
