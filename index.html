<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marvel Rivals - Guess Who?</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Oswald:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Oswald', sans-serif;
            background-color: #111827;
            color: #e2e8f0;
            font-weight: 400;
        }
        .font-bangers {
            font-family: 'Bangers', cursive;
        }
        .character-card {
            transition: transform 0.3s, filter 0.3s, opacity 0.3s, border-color 0.3s;
            cursor: pointer;
            border: 2px solid #4b5563;
        }
        .character-card:hover {
            transform: scale(1.05);
            border-color: #facc15;
        }
        .character-card.flipped {
            transform: scale(0.9);
            filter: grayscale(100%);
            opacity: 0.4;
        }
        .mystery-card { border: 2px dashed #4b5563; }
        .comic-title {
            color: #fef2f2;
            -webkit-text-stroke: 2px #ef4444;
            text-shadow: 4px 4px 0 #000;
        }
        .player-board.active {
            border-color: #facc15; /* Yellow-400 */
        }
        .player-board.active-p2 {
             border-color: #f87171; /* Red-400 */
        }
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.8); display: flex;
            justify-content: center; align-items: center; z-index: 100;
        }
        .modal-content {
            background-color: #1f2937; padding: 2rem; border-radius: 0.75rem;
            text-align: center; border: 1px solid #4b5563; box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        #game-container.hidden, #start-screen.hidden, .modal-backdrop.hidden { display: none; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <div class="text-center mb-8">
            <h1 class="text-6xl md:text-7xl font-bangers tracking-wider comic-title">Marvel Rivals: Guess Who?</h1>
            <p id="instructions" class="text-gray-400 mt-2 text-lg">Create or join a game to start playing!</p>
        </div>

        <!-- Start Screen -->
        <div id="start-screen" class="bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700 text-center max-w-lg mx-auto">
            <button id="createGameBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 text-lg rounded-lg shadow-lg transition-transform transform hover:scale-105">Create New Game</button>
            <div class="my-6 text-gray-400">OR</div>
            <div>
                <input type="text" id="gameIdInput" placeholder="Enter Game ID to Join" class="w-full max-w-xs bg-gray-700 text-white border border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-yellow-500">
                <button id="joinGameBtn" class="ml-2 bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105">Join Game</button>
            </div>
        </div>

        <!-- Game Container -->
        <div id="game-container" class="hidden">
            <div class="text-center mb-4">
                <p class="text-gray-400">Game ID: <strong id="gameIdDisplay" class="text-yellow-400 cursor-pointer" title="Click to copy"></strong></p>
                <p id="player-identity" class="font-bold text-xl"></p>
            </div>
            <div id="gameStatus" class="text-center text-3xl font-bangers tracking-wide mb-6 h-10"></div>
            
            <div id="player-board" class="player-board bg-gray-800 p-6 rounded-xl shadow-2xl border-4 border-transparent transition-colors duration-500">
                
                <!-- Character Grids by Role -->
                <div>
                    <h3 class="text-2xl font-bangers text-yellow-400 tracking-wider mb-2">Vanguards</h3>
                    <div id="vanguard-grid" class="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-8 lg:grid-cols-10 gap-4"></div>
                </div>
                <div class="mt-6">
                    <h3 class="text-2xl font-bangers text-red-400 tracking-wider mb-2">Duelists</h3>
                    <div id="duelist-grid" class="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-8 lg:grid-cols-10 gap-4"></div>
                </div>
                <div class="mt-6">
                    <h3 class="text-2xl font-bangers text-sky-400 tracking-wider mb-2">Strategists</h3>
                    <div id="strategist-grid" class="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-8 lg:grid-cols-10 gap-4"></div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8 pt-6 border-t-2 border-gray-700">
                    <div>
                        <h3 class="text-xl font-semibold text-center">Your Mystery Character</h3>
                        <div id="player-mystery-card" class="mystery-card bg-gray-900 rounded-lg p-4 mt-2 flex items-center justify-center h-28"></div>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold text-center">Opponent's Character</h3>
                        <div id="opponent-mystery-card" class="mystery-card bg-gray-900 rounded-lg p-4 mt-2 flex items-center justify-center h-28">
                            <span class="text-gray-500 text-2xl">?</span>
                        </div>
                    </div>
                </div>
                <div id="guess-area" class="mt-6 text-center hidden">
                    <h3 class="text-xl font-semibold">Guess Opponent's Character:</h3>
                    <input type="text" id="guess-input" placeholder="Type name..." class="mt-2 w-full max-w-xs bg-gray-700 text-white border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-500">
                    <button id="guess-btn" class="ml-2 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105">Guess</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Generic Modal -->
    <div id="modal" class="modal-backdrop hidden">
        <div class="modal-content w-11/12 max-w-md">
            <h3 id="modal-title" class="text-2xl font-bold mb-4">Notification</h3>
            <p id="modal-text" class="mb-6">This is a message.</p>
            <div id="modal-buttons" class="flex justify-center gap-4">
                <button id="modal-ok" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-8 rounded-lg">OK</button>
            </div>
        </div>
    </div>

    <script type="module">
        
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CHARACTER DATA ---
        const characters = [
            // Vanguards
            { name: 'Captain America', role: 'Vanguard' }, { name: 'Doctor Strange', role: 'Vanguard' }, { name: 'Emma Frost', role: 'Vanguard' },
            { name: 'Groot', role: 'Vanguard' }, { name: 'Hulk', role: 'Vanguard' }, { name: 'Magneto', role: 'Vanguard' },
            { name: 'Peni Parker', role: 'Vanguard' }, { name: 'The Thing', role: 'Vanguard' }, { name: 'Thor', role: 'Vanguard' },
            { name: 'Venom', role: 'Vanguard' },
            // Duelists
            { name: 'Black Panther', role: 'Duelist' }, { name: 'Black Widow', role: 'Duelist' }, { name: 'Hawkeye', role: 'Duelist' },
            { name: 'Hela', role: 'Duelist' }, { name: 'Human Torch', role: 'Duelist' }, { name: 'Iron Fist', role: 'Duelist' },
            { name: 'Iron Man', role: 'Duelist' }, { name: 'Magik', role: 'Duelist' }, { name: 'Mister Fantastic', role: 'Duelist' },
            { name: 'Moon Knight', role: 'Duelist' }, { name: 'Namor', role: 'Duelist' }, { name: 'Phoenix', role: 'Duelist' },
            { name: 'Psylocke', role: 'Duelist' }, { name: 'The Punisher', role: 'Duelist' }, { name: 'Scarlet Witch', role: 'Duelist' },
            { name: 'Squirrel Girl', role: 'Duelist' }, { name: 'Spider-Man', role: 'Duelist' }, { name: 'Star-Lord', role: 'Duelist' },
            { name: 'Storm', role: 'Duelist' }, { name: 'Winter Soldier', role: 'Duelist' }, { name: 'Wolverine', role: 'Duelist' },
            // Strategists
            { name: 'Adam Warlock', role: 'Strategist' }, { name: 'Cloak and Dagger', role: 'Strategist' }, { name: 'Invisible Woman', role: 'Strategist' },
            { name: 'Jeff the Land Shark', role: 'Strategist' }, { name: 'Loki', role: 'Strategist' }, { name: 'Luna Snow', role: 'Strategist' },
            { name: 'Mantis', role: 'Strategist' }, { name: 'Rocket Raccoon', role: 'Strategist' }, { name: 'Ultron', role: 'Strategist' }
        ];

        // --- FIREBASE & GAME STATE ---
        let app, auth, db;
        let gameId = null;
        let playerNumber = null;
        let gameUnsubscribe = null;
        let localGameState = {};

        // --- DOM ELEMENTS ---
        const startScreen = document.getElementById('start-screen');
        const gameContainer = document.getElementById('game-container');
        const gameStatus = document.getElementById('gameStatus');
        const instructions = document.getElementById('instructions');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalText = document.getElementById('modal-text');
        const modalButtons = document.getElementById('modal-buttons');
        const playerBoard = document.getElementById('player-board');

        // --- INITIALIZATION ---
        async function initialize() {
            const firebaseConfig = {
                apiKey: "AIzaSyA3vaJjSDTQyEquEhWNaTlohdz9kZjjbeE",
                authDomain: "marvelrivalsgame-65cb4.firebaseapp.com",
                projectId: "marvelrivalsgame-65cb4",
                storageBucket: "marvelrivalsgame-65cb4.firebasestorage.app",
                messagingSenderId: "120750810065",
                appId: "1:120750810065:web:2cea63a26b1079fb7576f0",
                measurementId: "G-V00GNPDWPJ"
            };

            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Authentication failed:", error);
                showModal("Authentication Error", "Could not sign in. Please refresh the page.");
            }

            document.getElementById('createGameBtn').onclick = createNewGame;
            document.getElementById('joinGameBtn').onclick = joinGame;
            document.getElementById('gameIdDisplay').onclick = copyGameId;
        }

        // --- GAME FLOW ---
        async function createNewGame() {
            const newGameId = generateGameId();
            const gameRef = getGameRef(newGameId);
            const shuffledCharacters = [...characters].sort(() => 0.5 - Math.random());

            const initialGameState = {
                gameState: 'selection',
                currentPlayer: 1,
                player1: { id: auth.currentUser.uid, mysteryCharacter: null },
                player2: { id: null, mysteryCharacter: null },
                winner: null,
                characters: shuffledCharacters.map(c => c.name)
            };

            try {
                await setDoc(gameRef, initialGameState);
                await setupGameSession(newGameId, 1);
            } catch (error) {
                console.error("Error creating game:", error);
                showModal("Error", "Could not create the game. Please try again.");
            }
        }

        async function joinGame() {
            const gameIdToJoin = document.getElementById('gameIdInput').value.trim().toUpperCase();
            if (!gameIdToJoin) {
                showModal("Input Required", "Please enter a Game ID.");
                return;
            }

            const gameRef = getGameRef(gameIdToJoin);
            const gameDoc = await getDoc(gameRef);

            if (!gameDoc.exists()) {
                showModal("Error", "Game not found. Please check the ID and try again.");
                return;
            }

            const gameData = gameDoc.data();
            const myUid = auth.currentUser.uid;

            if (gameData.player1.id === myUid) {
                if (!gameData.player2.id) {
                    showModal("You are Player 1", "You have already created this game. To play, ask a friend to join this game ID from their own device or a different browser profile (like an Incognito window).");
                }
                await setupGameSession(gameIdToJoin, 1);
                return;
            }

            if (gameData.player2.id && gameData.player2.id !== myUid) {
                showModal("Game Full", "This game already has two players.");
                return;
            }

            await updateDoc(gameRef, { 'player2.id': myUid });
            await setupGameSession(gameIdToJoin, 2);
        }

        function setupGameSession(newGameId, pNum) {
            gameId = newGameId;
            playerNumber = pNum;

            startScreen.classList.add('hidden');
            gameContainer.classList.remove('hidden');
            document.getElementById('gameIdDisplay').textContent = gameId;

            const playerIdentity = document.getElementById('player-identity');
            playerIdentity.textContent = `You are Player ${playerNumber}`;
            playerIdentity.className = `font-bold text-xl ${playerNumber === 1 ? 'text-yellow-400' : 'text-red-400'}`;

            if (gameUnsubscribe) gameUnsubscribe();
            gameUnsubscribe = onSnapshot(getGameRef(gameId), handleGameStateUpdate);
        }

        // --- REAL-TIME STATE HANDLER ---
        function handleGameStateUpdate(doc) {
            if (!doc.exists()) {
                showModal("Game Error", "The game session has ended or could not be found.", true);
                return;
            }
            localGameState = doc.data();
            
            const vanguardGrid = document.getElementById('vanguard-grid');
            if (vanguardGrid.children.length === 0 && localGameState.characters) {
                 const characterList = localGameState.characters.map(name => characters.find(c => c.name === name));
                 populateAllGrids(characterList);
            }

            updateUIFromState();
        }

        // --- UI UPDATES ---
        function updateUIFromState() {
            const { gameState, currentPlayer, winner, player1, player2 } = localGameState;
            
            playerBoard.classList.remove('active', 'active-p2');
            if (gameState === 'gameplay' && currentPlayer === playerNumber) {
                 playerBoard.classList.add(playerNumber === 1 ? 'active' : 'active-p2');
            }
            
            if (gameState === 'selection') {
                if ((playerNumber === 1 && !player1.mysteryCharacter) || (playerNumber === 2 && !player2.mysteryCharacter)) {
                    instructions.textContent = "Please choose your secret character from the board below.";
                } else {
                    instructions.textContent = "Waiting for your opponent to choose their character...";
                }
                gameStatus.textContent = '';
            } else if (gameState === 'gameplay') {
                instructions.textContent = "Ask yes/no questions to guess your opponent's mystery character.";
                gameStatus.textContent = `Player ${currentPlayer}'s Turn`;
                gameStatus.className = `text-center text-3xl font-bangers tracking-wide mb-6 h-10 ${currentPlayer === 1 ? 'text-yellow-400' : 'text-red-400'}`;
                document.getElementById('guess-area').classList.remove('hidden');
            } else if (gameState === 'gameover') {
                instructions.textContent = "Game Over! Return to the start screen to play again.";
                gameStatus.textContent = `Player ${winner} wins!`;
                gameStatus.className = 'text-center text-4xl font-bangers tracking-wider mb-6 h-10 text-green-400';
                document.getElementById('guess-area').classList.add('hidden');
                
                const opponentCharName = playerNumber === 1 ? player2.mysteryCharacter : player1.mysteryCharacter;
                const opponentChar = characters.find(c => c.name === opponentCharName);
                if(opponentChar) displayMysteryCard('opponent-mystery-card', opponentChar);
            }

            const myCharName = playerNumber === 1 ? player1.mysteryCharacter : player2.mysteryCharacter;
            if (myCharName) {
                const myChar = characters.find(c => c.name === myCharName);
                if(myChar) displayMysteryCard('player-mystery-card', myChar);
            }
        }
        
        function populateAllGrids(charList) {
            const vanguardGrid = document.getElementById('vanguard-grid');
            const duelistGrid = document.getElementById('duelist-grid');
            const strategistGrid = document.getElementById('strategist-grid');

            vanguardGrid.innerHTML = '';
            duelistGrid.innerHTML = '';
            strategistGrid.innerHTML = '';

            charList.forEach(char => {
                if (!char) return; // Safeguard for any missing characters
                const card = createCharacterCard(char);
                if (char.role === 'Vanguard') {
                    vanguardGrid.appendChild(card);
                } else if (char.role === 'Duelist') {
                    duelistGrid.appendChild(card);
                } else if (char.role === 'Strategist') {
                    strategistGrid.appendChild(card);
                }
            });
        }

        function createCharacterCard(char) {
            const card = document.createElement('div');
            card.className = 'character-card bg-gray-700 rounded-lg p-2 text-center shadow-md';
            card.dataset.charName = char.name;
            card.innerHTML = `
                <img src="https://placehold.co/100x100/1f2937/fef2f2?text=${encodeURIComponent(char.name.replace(' ','\n'))}" alt="${char.name}" class="w-full h-auto rounded-md mx-auto pointer-events-none">
                <p class="mt-2 text-xs font-semibold truncate pointer-events-none">${char.name}</p>
            `;
            card.onclick = () => handleCardClick(char, card);
            return card;
        }

        function displayMysteryCard(elementId, character) {
            const container = document.getElementById(elementId);
            container.innerHTML = `
                <div class="text-center">
                    <p class="text-lg font-bold text-yellow-400">${character.name}</p>
                    <p class="text-xs text-gray-400">(${character.role})</p>
                </div>
            `;
        }

        // --- PLAYER ACTIONS ---
        function handleCardClick(character, cardElement) {
            const { gameState, player1, player2 } = localGameState;
            if (gameState === 'selection') {
                const myCharacter = playerNumber === 1 ? player1.mysteryCharacter : player2.mysteryCharacter;
                if (myCharacter) {
                    showModal("Already Chosen", "You have already selected your character.");
                    return;
                }
                showConfirmationModal(character);
            } else if (gameState === 'gameplay') {
                cardElement.classList.toggle('flipped');
            }
        }

        async function confirmSelection(character) {
            const gameRef = getGameRef(gameId);
            const updateData = {};
            if (playerNumber === 1) {
                updateData['player1.mysteryCharacter'] = character.name;
            } else {
                updateData['player2.mysteryCharacter'] = character.name;
            }

            const opponentChar = playerNumber === 1 ? localGameState.player2.mysteryCharacter : localGameState.player1.mysteryCharacter;
            if (opponentChar) {
                updateData.gameState = 'gameplay';
            }
            
            await updateDoc(gameRef, updateData);
        }

        async function handleGuess() {
            const { gameState, currentPlayer } = localGameState;
            if (gameState !== 'gameplay' || currentPlayer !== playerNumber) {
                showModal("Not Your Turn", "It's not your turn to guess.");
                return;
            }

            const guessInput = document.getElementById('guess-input');
            const guess = guessInput.value.trim().toLowerCase();
            if (!guess) {
                showModal("Input Required", "Please enter a character's name.");
                return;
            }

            const opponentCharName = (playerNumber === 1) ? localGameState.player2.mysteryCharacter : localGameState.player1.mysteryCharacter;
            const gameRef = getGameRef(gameId);

            if (guess === opponentCharName.toLowerCase()) {
                await updateDoc(gameRef, { gameState: 'gameover', winner: playerNumber });
            } else {
                showModal("Incorrect Guess!", "That was not the correct character. Your turn is over.");
                await updateDoc(gameRef, { currentPlayer: playerNumber === 1 ? 2 : 1 });
            }
            guessInput.value = '';
        }
        
        document.getElementById('guess-btn').onclick = handleGuess;

        // --- UTILITIES ---
        function getGameRef(id) {
            return doc(db, "guess-who-games", id);
        }

        function generateGameId() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }
        
        function copyGameId() {
            navigator.clipboard.writeText(gameId).then(() => {
                showModal("Copied!", `Game ID ${gameId} has been copied to your clipboard.`);
            }, () => {
                showModal("Copy Failed", "Could not copy the Game ID.");
            });
        }

        function showModal(title, text, isError = false) {
            modal.classList.remove('hidden');
            modalTitle.textContent = title;
            modalText.textContent = text;
            modalButtons.innerHTML = '';

            const okButton = document.createElement('button');
            okButton.textContent = 'OK';
            okButton.className = 'bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-8 rounded-lg';
            okButton.onclick = () => {
                modal.classList.add('hidden');
                if (isError) {
                    gameContainer.classList.add('hidden');
                    startScreen.classList.remove('hidden');
                    if(gameUnsubscribe) gameUnsubscribe();
                }
            };
            modalButtons.appendChild(okButton);
        }

        function showConfirmationModal(character) {
            modal.classList.remove('hidden');
            modalTitle.textContent = "Confirm Selection";
            modalText.textContent = `Do you want to choose ${character.name}?`;
            modalButtons.innerHTML = '';
            
            const yesButton = document.createElement('button');
            yesButton.textContent = 'Yes';
            yesButton.className = 'bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg';
            yesButton.onclick = () => {
                confirmSelection(character);
                modal.classList.add('hidden');
            };

            const noButton = document.createElement('button');
            noButton.textContent = 'No';
            noButton.className = 'bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg';
            noButton.onclick = () => modal.classList.add('hidden');

            modalButtons.appendChild(yesButton);
            modalButtons.appendChild(noButton);
        }

        // --- START THE APP ---
        initialize();
    </script>
</body>
</html>
